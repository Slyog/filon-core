name: FILON QA CI

on:
  push:
    branches: [dev, main]
  pull_request:
  workflow_dispatch:

jobs:
  qa:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository for QA execution
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      # Block npm usage to enforce pnpm-only installs
      - name: üö´ Disable npm globally
        run: |
          NPM_BIN="$(which npm)"
          if [ -n "$NPM_BIN" ] && [ -e "$NPM_BIN" ]; then
            sudo mv "$NPM_BIN" "${NPM_BIN}.bak"
          fi

      # Prepare Node runtime and enable pnpm cache mode
      - name: üß© Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      # Restore pnpm store cache for faster installs
      - name: üì¶ Restore pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      # Restore cached Playwright browsers
      - name: üé≠ Restore Playwright cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      # Activate pnpm through corepack
      - name: üì¶ Activate pnpm
        run: |
          corepack enable
          corepack prepare pnpm@9.12.0 --activate
          pnpm --version

      # Eliminate conflicting lockfiles
      - name: üßπ Clean npm/yarn lockfiles
        run: |
          rm -f package-lock.json yarn.lock npm-shrinkwrap.json
          echo "‚úÖ Removed npm/yarn lockfiles."

      # Install dependencies solely with pnpm
      - name: üì¶ Install Dependencies (pnpm)
        run: |
          echo "üì¶ Installing dependencies via pnpm..."
          pnpm install --frozen-lockfile || pnpm install

      # Provide Prisma fallback environment and validate prerequisites
      - name: üõ°Ô∏è CI Sanity Check
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo 'DATABASE_URL="file:./ci.db"' > .env
          echo "::notice ::DATABASE_URL set to SQLite fallback."
          if [ ! -f prisma/schema.prisma ]; then
            echo "::error ::Prisma schema missing at prisma/schema.prisma"
            exit 1
          fi
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "::error ::DISCORD_WEBHOOK_URL secret is not configured."
            exit 1
          fi
          cat .env

      # Generate Prisma client with retry safety
      - name: üß¨ Generate Prisma Client
        run: |
          npx prisma generate || (pnpm install && npx prisma generate)

      # Run full Playwright QA suite in headless mode with retry
      - name: üöÄ Run Playwright QA Tests
        env:
          PW_HEADLESS: "1"
        run: |
          mkdir -p tests/__snapshots__/autosave
          mkdir -p playwright-report
          echo "üöÄ Running Playwright tests..."
          pnpm run qa:all || (
            echo "‚ö†Ô∏è QA failed, retrying..." &&
            npx prisma generate &&
            sleep 5 &&
            pnpm run qa:all || echo "‚ùå QA tests failed after retry."
          )

      # Upload QA results for inspection
      - name: üì§ Upload QA Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-ci-artifacts
          path: |
            tests/__snapshots__/autosave
            playwright-report
            qa/reports
          if-no-files-found: ignore

      # Discord success notification
      - name: ‚úÖ Discord Notify (Success)
        if: success()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "üöÄ FILON QA CI Passed"
          embed-description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Status:** ‚úÖ Success
          embed-color: 3145775
          embed-footer-text: "FILON QA CI"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}

      # Discord failure notification
      - name: üî¥ Discord Notify (Failure)
        if: failure()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "‚ùå FILON QA CI Failed"
          embed-description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Status:** ‚ùå Failure
            **Action Required:** Review QA artifacts.
          embed-color: 16711680
          embed-footer-text: "FILON QA CI"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}