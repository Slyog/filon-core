name: FILON Preview Deploy

# disabled until MVP is ready
on:
  workflow_dispatch:
  # on: none

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository for preview build
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      # Enforce pnpm-only installs
      - name: ğŸš« Disable npm globally
        run: |
          NPM_BIN="$(which npm)"
          if [ -n "$NPM_BIN" ] && [ -e "$NPM_BIN" ]; then
            sudo mv "$NPM_BIN" "${NPM_BIN}.bak"
          fi

      # Setup Node and prepare pnpm support
      - name: ğŸ§© Setup Node.js (20.x)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          check-latest: true

      # Enable Corepack-managed pnpm
      - name: âš™ï¸ Enable Corepack and install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@9.12.0 --activate
          echo "âœ… pnpm version: $(pnpm --version)"

      # Restore pnpm and Playwright caches
      - name: ğŸ’¾ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # Ensure pnpm CLI is in PATH
      - name: ğŸ” Verify pnpm availability
        run: |
          if ! command -v pnpm &> /dev/null; then
            echo "âš ï¸ Corepack not applied properly, reinstalling pnpm..."
            npm install -g pnpm@9.12.0
          fi
          pnpm --version

      # Remove conflicting lockfiles
      - name: ğŸ§¹ Clean npm/yarn lockfiles
        run: |
          rm -f package-lock.json yarn.lock npm-shrinkwrap.json
          echo "âœ… Removed npm/yarn lockfiles."

      # Install dependencies strictly via pnpm
      - name: ğŸ“¦ Install Dependencies (pnpm)
        run: |
          echo "ğŸ“¦ Installing dependencies via pnpm..."
          pnpm install --frozen-lockfile || pnpm install

      # Provide fallback DATABASE_URL for Prisma
      - name: ğŸ§ª Setup SQLite fallback for Prisma
        run: |
          echo 'DATABASE_URL="file:./ci.db"' > .env
          cat .env

      # Generate Prisma client with retry guard
      - name: ğŸ§¬ Generate Prisma Client
        run: |
          npx prisma generate || (pnpm install && npx prisma generate)

      # Build preview bundle and collect output
      - name: ğŸ—ï¸ Build Preview Bundle
        env:
          PW_HEADLESS: "1"
        run: |
          pnpm run build
          pnpm exec playwright install --with-deps

      # Upload preview build artifacts
      - name: ğŸ“¤ Upload Preview Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: filon-preview-artifacts
          path: |
            .next
            qa/reports
          if-no-files-found: ignore

      # Notify Discord of successful preview build
      - name: âœ… Discord Notify (Success)
        if: success()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "ğŸš€ FILON Preview Build Ready"
          embed-description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Status:** âœ… Success
          embed-color: 3145775
          embed-footer-text: "FILON Preview"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}

      # Notify Discord if preview build fails
      - name: ğŸ”´ Discord Notify (Failure)
        if: failure()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "âŒ FILON Preview Build Failed"
          embed-description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Status:** âŒ Failure
            **Action Required:** Inspect preview artifacts.
          embed-color: 16711680
          embed-footer-text: "FILON Preview"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}