name: üß† FILON CI/CD Pipeline

on:
  push:
    branches: [dev, main]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # --- Auto Node Setup ---
      - name: üß© Setup Node.js (Auto-Heal)
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: üß† Detect & Install Package Manager
        run: |
          echo "üîç Detecting package manager..."
          if [ -f "pnpm-lock.yaml" ]; then
            echo "Found pnpm-lock.yaml ‚Üí using pnpm"
            npm install -g pnpm
            pnpm install
          elif [ -f "yarn.lock" ]; then
            echo "Found yarn.lock ‚Üí using yarn"
            npm install -g yarn
            yarn install
          else
            echo "Using npm"
            npm install
          fi

      # === Prisma Generate & QA Run ===
      - name: üß¨ Prepare Prisma Client
        run: |
          echo "üß¨ Generating Prisma client..."
          npx prisma generate || (echo "‚ö†Ô∏è Prisma generation failed ‚Äî attempting reinstall" && npm install && npx prisma generate)
          echo "‚úÖ Prisma client ready."

      - name: üß™ Run QA Suite (Auto-Retry)
        run: |
          echo "üöÄ Running Playwright QA tests..."
          export PW_HEADLESS=1
          npm run qa:all || (
            echo "‚ö†Ô∏è QA failed, retrying after regeneration..." &&
            npx prisma generate &&
            sleep 5 &&
            npm run qa:all ||
            echo "‚ùå QA tests failed after retry."
          )

      # --- Generate QA Reports ---
      - name: üßæ Generate QA Report (JSON + Markdown)
        if: success()
        run: |
          mkdir -p qa/reports
          REPORT_PATH="qa/reports/latest.json"
          REPORT_MD="qa/reports/latest.md"
          echo "{
            \"build\": \"$(date -u)\",
            \"branch\": \"${{ github.ref_name }}\",
            \"commit\": \"${{ github.sha }}\",
            \"status\": \"success\"
          }" > $REPORT_PATH
          echo "## ‚úÖ FILON CI Build Summary
          - **Branch:** ${{ github.ref_name }}
          - **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **Status:** ‚úÖ Success
          - **Build Time (UTC):** $(date -u)
          " > $REPORT_MD

      # --- Push Reports Back ---
      - name: üì§ Commit & Push QA Reports
        if: success()
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions[bot]"
          git add qa/reports/
          git commit -m "ci(report): update QA summary" || echo "no changes"
          git push origin dev || echo "no push perms"

      # --- Discord Success ---
      - name: üì° Discord Notify (Success)
        if: success()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "üöÄ FILON CI Passed"
          embed-description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Status:** ‚úÖ Success
            **Author:** ${{ github.actor }}
          embed-color: 3145775
          embed-footer-text: "FILON Auto-Heal CI"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}

      # --- Discord Failure ---
      - name: üî¥ Discord Notify (Failure)
        if: failure()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "‚ùå FILON CI Failed"
          embed-description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Status:** ‚ùå Failure
            **Action Required:** Check QA logs on GitHub.
          embed-color: 16711680
          embed-footer-text: "FILON Auto-Heal CI"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}
