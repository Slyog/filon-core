name: üß† FILON CI/CD Pipeline

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]

jobs:
  health-check:
    name: üîç QA Health Check
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # === Setup Node Environment ===
      - name: üß© Setup Node.js (No Lockfile Cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'false'   # Prevents error if package-lock.json or yarn.lock is missing

      - name: üì¶ Install Dependencies
        run: |
          npm install
          echo "‚úÖ Dependencies installed successfully (no lockfile cache)."

      - name: üß∞ Verify pnpm environment
        run: |
          pnpm --version
          pnpm store path

      - name: üîí Verify lockfile integrity
        run: |
          echo "Checking pnpm-lock.yaml consistency..."
          pnpm install --frozen-lockfile --ignore-scripts
          echo "‚úÖ Lockfile verification complete."

      - name: üß± Verify workspace links
        run: |
          echo "Checking workspace links..."
          pnpm recursive exec echo "Workspace OK"
          echo "‚úÖ Workspace integrity OK."

      - name: üßπ Cleanup cache
        run: |
          pnpm store prune

      - name: üßπ Prune and save cache
        if: always()
        run: |
          pnpm store prune

  build-and-test:
    runs-on: ubuntu-latest
    needs: [health-check]

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # === Setup Node Environment ===
      - name: üß© Setup Node.js (No Lockfile Cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'false'   # Prevents error if package-lock.json or yarn.lock is missing

      - name: üì¶ Install Dependencies
        run: |
          npm install
          echo "‚úÖ Dependencies installed successfully (no lockfile cache)."

      - name: üß™ Run QA & Tests
        run: pnpm run qa:all

      - name: üèóÔ∏è Build FILON
        run: pnpm run build

      - name: üìä Artifact Summary
        run: |
          echo "Build finished at $(date)"
          du -sh .next || true

      - name: üßπ Prune and save cache
        if: always()
        run: |
          pnpm store prune

      # === QA Auto-Reporting ===
      - name: üßæ Generate QA Report (JSON + Markdown)
        if: success()
        run: |
          mkdir -p qa/reports
          REPORT_PATH="qa/reports/latest.json"
          REPORT_MD="qa/reports/latest.md"

          echo "{\n            \"build\": \"$(date -u)\",\n            \"branch\": \"${{ github.ref_name }}\",\n            \"commit\": \"${{ github.sha }}\",\n            \"status\": \"success\"\n          }" > $REPORT_PATH

          echo "## ‚úÖ FILON CI Build Summary\n          - **Branch:** ${{ github.ref_name }}\n          - **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\n          - **Status:** ‚úÖ Success\n          - **Build Time (UTC):** $(date -u)\n          " > $REPORT_MD

          echo "QA reports written to $REPORT_PATH and $REPORT_MD"

      - name: üì§ Commit & Push QA Reports
        if: success()
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions[bot]"
          git add qa/reports/
          git commit -m "ci(report): update QA build summary" || echo "No changes to commit"
          git push origin dev || echo "‚ö†Ô∏è Skipped push (no permissions or no changes)"

      - name: üì° Send Discord Notification
        if: success()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          payload-json: |
            {
              "embeds": [
                {
                  "title": "üöÄ FILON CI Build Passed",
                  "description": "**Branch:** ${{ github.ref_name }}\n**Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\n**Status:** ‚úÖ Success\n**Author:** ${{ github.actor }}",
                  "color": 3145775,
                  "footer": { "text": "FILON CI Auto-Reporter" },
                  "timestamp": "${{ github.event.head_commit.timestamp }}"
                }
              ]
            }
