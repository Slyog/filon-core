name: FILON Build & Test

on:
  push:
    branches: [dev, main]
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4

      # Disable npm so installs must use pnpm
      - name: ğŸš« Disable npm globally
        run: |
          NPM_BIN="$(command -v npm || true)"
          if [ -n "$NPM_BIN" ] && [ -e "$NPM_BIN" ]; then
            sudo mv "$NPM_BIN" "${NPM_BIN}.bak"
            echo "DISABLED_NPM_BIN=${NPM_BIN}.bak" >> $GITHUB_ENV
          fi

      # Prepare Node runtime with pnpm support
      - name: ğŸ§© Setup Node.js (20.x)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          check-latest: true

      # Turn on pnpm via corepack
      - name: âš™ï¸ Enable Corepack and install pnpm
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@9.12.0 --activate
          echo "âœ… pnpm version: $(pnpm --version)"

      # Restore pnpm cache
      - name: ğŸ’¾ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ğŸ” Verify pnpm availability
        run: |
          if ! command -v pnpm &> /dev/null; then
            echo "âš ï¸ Corepack not applied properly, reinstalling pnpm..."
            npm install -g pnpm@9.12.0
          fi
          pnpm --version

      # Remove foreign lockfiles to avoid conflicts
      - name: ğŸ§¹ Clean npm/yarn lockfiles
        run: |
          rm -f package-lock.json yarn.lock npm-shrinkwrap.json
          echo "âœ… Removed npm/yarn lockfiles."

      # Install dependencies strictly with pnpm (equivalent to npm ci)
      - name: ğŸ“¦ Install Dependencies (pnpm ci)
        run: |
          echo "ğŸ“¦ Installing dependencies via pnpm (frozen lockfile)..."
          pnpm install --frozen-lockfile || pnpm install

      # Provide fallback DATABASE_URL for Prisma
      - name: ğŸ§ª Setup SQLite fallback for Prisma
        run: |
          echo 'DATABASE_URL="file:./ci.db"' > .env
          cat .env

      # Generate Prisma client with auto-heal safety net
      - name: ğŸ§¬ Generate Prisma Client
        run: |
          npx prisma generate || (pnpm install && npx prisma generate)

      # Lint Next.js project (warnings allowed, don't stop build)
      - name: ğŸ§¹ Run ESLint
        continue-on-error: true
        run: pnpm run lint || echo "âš ï¸ Lint warnings found (non-blocking)"

      # Ensure TypeScript types stay correct
      - name: ğŸ§  Type Check
        run: pnpm exec tsc --noEmit

      # Build production bundle
      - name: ğŸ—ï¸ Build Application
        run: pnpm run build

