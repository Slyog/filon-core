name: FILON QA

on:
  push:
    branches: [dev, main]
  pull_request:
  workflow_dispatch:

jobs:
  qa:
    runs-on: ubuntu-latest
    steps:
      # === Setup ===
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: üß© Setup Node.js + pnpm
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: üì¶ Install pnpm
        run: npm install -g pnpm

      - name: üßπ Clean workspace
        run: |
          rm -rf node_modules .next dist .turbo
          pnpm store prune || true

      # === Environment + Prisma ===
      - name: üß™ Setup SQLite fallback for Prisma
        run: |
          echo 'DATABASE_URL="file:./ci.db"' > .env
          cat .env

      - name: üß¨ Generate Prisma Client
        run: |
          pnpm install --no-frozen-lockfile
          npx prisma generate || (pnpm install && npx prisma generate)

      # === QA ===
      - name: üöÄ Run Playwright QA Tests
        run: |
          pnpm run qa:all || (
            echo "‚ö†Ô∏è QA failed, retrying..." &&
            npx prisma generate &&
            sleep 5 &&
            pnpm run qa:all || echo "‚ùå QA tests failed after retry."
          )

      # === Discord Notifications ===
      - name: ‚úÖ Discord Notify (Success)
        if: success()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "üöÄ FILON QA Passed"
          embed-description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Status:** ‚úÖ Success
          embed-color: 3145775
          embed-footer-text: "FILON QA Runner"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}

      - name: üî¥ Discord Notify (Failure)
        if: failure()
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "‚ùå FILON QA Failed"
          embed-description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Status:** ‚ùå Failure
            **Action Required:** Check QA logs.
          embed-color: 16711680
          embed-footer-text: "FILON QA Runner"
          embed-timestamp: ${{ github.event.head_commit.timestamp }}
